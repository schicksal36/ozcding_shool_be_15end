from django.conf import settings
from django.shortcuts import render, redirect
from django.contrib.auth.forms import UserCreationForm, AuthenticationForm
from django.contrib.auth import login as django_login


# ============================================================
# ✅ 회원가입 + 로그인 관련 View 모음
# ------------------------------------------------------------
# 이 파일의 목표:
# 1) 회원가입(sign_up): 유저 계정 생성 + (성공 시) 자동 로그인
# 2) 로그인(login): 아이디/비밀번호 검증 후 세션 로그인
#
# ✅ Django 인증(Auth) 핵심 개념 (세션 기반)
# - django_login(request, user)를 호출하면:
#   1) Django가 세션(session)에 "이 사용자가 로그인 상태"라고 기록
#   2) 브라우저에 sessionid 쿠키를 내려줌
#   3) 이후 요청마다 sessionid로 로그인 상태를 복원함
# - 즉, JWT가 아니라 "서버 세션 + 쿠키" 방식임
# ============================================================


# =========================
# 📝 회원가입
# =========================
def sign_up(request):
    # --------------------------------------------------------
    # ✅ UserCreationForm
    # - Django가 기본 제공하는 회원가입 폼
    # - 기본 필드: username, password1, password2
    # - 내부에서 하는 일:
    #   1) username 중복 검사
    #   2) password1/password2 일치 검사
    #   3) 비밀번호 정책(길이/단순성 등) 검사
    #   4) 최종적으로 User 객체 생성 시 비밀번호를 해시로 저장
    # --------------------------------------------------------

    # --------------------------------------------------------
    # ✅ (request.POST or None) 패턴의 의미
    # - GET 요청일 때: request.POST는 빈 QueryDict(= falsy) → None
    #   → form = UserCreationForm(None) == 빈 폼
    # - POST 요청일 때: request.POST가 존재 → 그 값으로 폼 바인딩
    #   → 사용자가 입력한 username/password를 검증할 준비 완료
    #
    # 즉, GET/POST를 if문으로 나누지 않고도
    # "GET: 빈 폼 / POST: 바인딩 폼"을 한번에 처리하는 스타일
    # --------------------------------------------------------
    form = UserCreationForm(request.POST or None)

    # --------------------------------------------------------
    # ✅ form.is_valid()
    # - 폼에 바인딩된 데이터가 유효한지 검사
    # - 유효하면 True, 아니면 False
    # - 유효하지 않을 경우 form.errors 안에 에러 메시지가 담김
    #   → 템플릿에서 {{ form.as_p }} 같은 걸로 출력하면 에러가 같이 보임
    # --------------------------------------------------------
    if form.is_valid():
        # ----------------------------------------------------
        # ✅ form.save()
        # - User 객체를 DB에 저장
        # - 여기서 비밀번호는 평문 저장이 아니라 자동으로 해싱됨
        # - 반환값: 저장된 User 인스턴스
        # ----------------------------------------------------
        user = form.save()

        # ----------------------------------------------------
        # ✅ 회원가입 성공 후 자동 로그인
        # - django_login()은 "세션 로그인" 처리
        # - 실행 결과:
        #   1) request.user가 이 user로 인증된 상태가 됨
        #   2) response에 sessionid 쿠키가 설정됨
        #   3) 이후 페이지에서 request.user.username 같은 값 사용 가능
        # ----------------------------------------------------
        django_login(request, user)

        # ----------------------------------------------------
        # ✅ 로그인 후 이동할 URL로 리다이렉트
        # - settings.LOGIN_REDIRECT_URL 값을 사용
        # - 보통 settings.py에 아래처럼 설정해둠:
        #   LOGIN_REDIRECT_URL = "/blog/" 또는 "/"
        # - 장점: 코드에 하드코딩('/') 하지 않고 설정으로 관리 가능
        # ----------------------------------------------------
        return redirect(settings.LOGIN_REDIRECT_URL)

    # --------------------------------------------------------
    # ✅ GET 요청이거나 / POST인데 유효성 실패한 경우
    # - signup.html 템플릿을 렌더링
    # - form 객체를 넘기면:
    #   - GET: 빈 폼 화면
    #   - POST 실패: 에러가 포함된 폼 화면 (username 중복, 비번 불일치 등)
    # --------------------------------------------------------
    return render(
        request,
        'registration/signup.html',
        {'form': form}
    )


# =========================
# 🔐 로그인
# =========================
def login(request):
    # --------------------------------------------------------
    # ✅ AuthenticationForm
    # - Django 기본 로그인 검증 폼
    # - 기본 필드: username, password
    # - 내부에서 하는 일:
    #   1) 해당 username이 존재하는지 확인
    #   2) password가 맞는지 authenticate()로 검증
    #   3) 맞으면 "인증된 user 객체"를 내부에 저장해 둠
    # --------------------------------------------------------

    if request.method == "POST":
        # ----------------------------------------------------
        # ✅ POST 요청: 사용자가 로그인 버튼을 눌렀을 때
        # - form에 request.POST 데이터를 바인딩해서 검증 준비
        # - 첫 번째 인자 request: 폼이 request 정보를 활용할 수 있음
        #   (보안/세션/백엔드 인증 처리에 필요)
        # ----------------------------------------------------
        form = AuthenticationForm(request, data=request.POST)

        # ----------------------------------------------------
        # ✅ form.is_valid() (⭐ 핵심)
        # - 아이디/비밀번호가 맞으면 True
        # - 틀리면 False
        # - 틀렸을 때 에러 메시지는 form.errors에 들어가고
        #   템플릿에서 그대로 출력 가능
        # ----------------------------------------------------
        if form.is_valid():
            # ------------------------------------------------
            # ✅ form.get_user()
            # - is_valid()를 통과한 경우에만 의미 있음
            # - 내부에서 인증된 사용자(User 객체)를 꺼내줌
            # ------------------------------------------------
            user = form.get_user()

            # ------------------------------------------------
            # ✅ django_login(request, user)
            # - 세션 로그인 처리 (sessionid 쿠키 발급)
            # - 이후부터 request.user가 로그인한 유저가 됨
            # ------------------------------------------------
            django_login(request, user)

            # ------------------------------------------------
            # ✅ 로그인 성공 후 이동
            # - settings.LOGIN_REDIRECT_URL로 이동
            # - 예: "/blog/" "/dashboard/" 등
            # ------------------------------------------------
            return redirect(settings.LOGIN_REDIRECT_URL)

        # ----------------------------------------------------
        # ✅ POST인데 is_valid() 실패하면
        # - 아래 render로 내려가며
        # - 에러 포함된 form이 템플릿에 전달되어
        #   "아이디/비번 틀림" 같은 메시지를 보여줄 수 있음
        # ----------------------------------------------------

    else:
        # ----------------------------------------------------
        # ✅ GET 요청: 로그인 페이지를 처음 열었을 때
        # - 빈 로그인 폼 생성
        #
        # ⚠️ 여기서는 AuthenticationForm(request) 또는 AuthenticationForm()
        # 둘 다 가능하지만, request를 넘겨주는 형태가 흔함
        # ----------------------------------------------------
        form = AuthenticationForm(request)

    # --------------------------------------------------------
    # ✅ GET 요청이거나 / POST 실패한 경우
    # - login.html 템플릿 렌더링
    # - form 전달:
    #   - GET: 빈 폼
    #   - POST 실패: 에러 메시지 포함된 폼
    # --------------------------------------------------------
    return render(
        request,
        'registration/login.html',
        {'form': form}
    )
