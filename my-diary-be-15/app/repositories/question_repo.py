#app\repositories\question_repo.py
from typing import Optional
from app.models.question import Question, UserQuestion
import random


class QuestionRepository:
    """
    ğŸ“Œ Repository Layer (ì €ì¥ì†Œ ê³„ì¸µ)
    ---------------------------------------------------------------
    - ì˜¤ì§ DB ì ‘ê·¼ë§Œ ë‹´ë‹¹.
    - ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§(Service)ì™€ ë¶„ë¦¬í•´ì„œ ìœ ì§€ë³´ìˆ˜ ë° ì¬ì‚¬ìš©ì„±ì„ ë†’ì„.
    - FastAPI êµ¬ì¡° íë¦„:
        API(Route) â†’ Service â†’ Repository(DB ì‘ì—…) â†’ Model
    """

    @staticmethod
    async def get_random_unassigned_question(user_id: int) -> Optional[Question]:
        """
        ğŸ“Œ íŠ¹ì • ì‚¬ìš©ìì—ê²Œ ì•„ì§ ì£¼ì–´ì§€ì§€ ì•Šì€ ëœë¤ ì§ˆë¬¸ 1ê°œ ë°˜í™˜

        ë™ì‘ ìˆœì„œ:
        ---------------------------------------------------------------
        1) UserQuestion í…Œì´ë¸”ì—ì„œ user_idê°€ ì´ë¯¸ ë°›ì€ ì§ˆë¬¸(question_id) ëª©ë¡ ì¡°íšŒ
        2) Question í…Œì´ë¸”ì—ì„œ "ì´ë¯¸ ë°›ì€ ì§ˆë¬¸ì„ ì œì™¸í•œ" ì§ˆë¬¸ ëª©ë¡ ì¡°íšŒ
        3) Python random.choice() ë¡œ í•˜ë‚˜ ë½‘ê¸° (ëœë¤)
        4) ì¡´ì¬í•˜ë©´ Question ê°ì²´ 1ê°œ ë°˜í™˜, ì—†ìœ¼ë©´ None ë°˜í™˜
        """

        # ---------------------------------------------------------------
        # [1] ìœ ì €ê°€ ì§€ê¸ˆê¹Œì§€ ë°›ì•˜ë˜ ì§ˆë¬¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        #     (N:M ê´€ê³„ UserQuestionì—ì„œ user_idê°€ ë°›ì€ question_id ë¦¬ìŠ¤íŠ¸)
        #
        # ì˜ˆì‹œ ê²°ê³¼:
        #     answered_question_ids = [3, 10, 22, 50]
        #
        # values_list(... flat=True) â†’ ë‹¨ìˆœ ì •ìˆ˜ ë¦¬ìŠ¤íŠ¸ í˜•íƒœë¡œ ë°˜í™˜.
        # ---------------------------------------------------------------
        answered_question_ids = await UserQuestion.filter(
            user_id=user_id
        ).values_list("question_id", flat=True)

        # ---------------------------------------------------------------
        # [2] ì•„ì§ ë°›ì§€ ì•Šì€ ì§ˆë¬¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        #
        # id__not_in=answered_question_ids â†’ "ì´ ë¦¬ìŠ¤íŠ¸ì— ì—†ëŠ” idë§Œ ê°€ì ¸ì™€!"
        #
        # ì˜ˆ:
        # Question í…Œì´ë¸”ì— ì´ 200ê°œê°€ ìˆë‹¤ë©´
        # ë°›ì€ ì§ˆë¬¸ 4ê°œ ì œì™¸í•˜ê³  â†’ 196ê°œ ë‚¨ìŒ
        #
        # ê²°ê³¼ëŠ” ê°ì²´ ë¦¬ìŠ¤íŠ¸ í˜•íƒœ:
        #   [Question(id=1), Question(id=5), Question(id=7), ...]
        # ---------------------------------------------------------------
        unassigned_questions = await Question.filter(
            id__not_in=answered_question_ids
        )

        # ---------------------------------------------------------------
        # [3] ëœë¤ ì„ íƒ
        # ---------------------------------------------------------------
        # Python random.choice() íŠ¹ì§•:
        #   - ë¦¬ìŠ¤íŠ¸ì—ì„œ í•˜ë‚˜ë¥¼ ë¬´ì‘ìœ„ë¡œ ë¹ ë¥´ê²Œ ì„ íƒ
        #   - DBì—ì„œ ëœë¤ ì •ë ¬(Order By Random())ì„ ìˆ˜í–‰í•˜ëŠ” ê²ƒë³´ë‹¤ ê°€ë²¼ì›€
        #
        # ì¡°ê±´:
        #   - ë¦¬ìŠ¤íŠ¸ê°€ ë¹„ì–´ìˆì§€ ì•Šì•„ì•¼ choice() ì‚¬ìš© ê°€ëŠ¥
        #
        # ê²°ê³¼:
        #   â†’ Question ê°ì²´ 1ê°œ
        #
        # ì˜ˆ:
        #   unassigned_questions â†’ [Q1, Q2, Q3]
        #   random.choice â†’ Q2 ì„ íƒ
        # ---------------------------------------------------------------
        if unassigned_questions:
            return random.choice(unassigned_questions)

        # ---------------------------------------------------------------
        # [4] ëª¨ë“  ì§ˆë¬¸ì„ ë‹¤ ë°›ì•˜ê±°ë‚˜ ì§ˆë¬¸ í…Œì´ë¸”ì´ ë¹„ì–´ ìˆìœ¼ë©´ None ë°˜í™˜
        #     â†’ ì„œë¹„ìŠ¤ì—ì„œ ì´ë¥¼ catchí•´ì„œ 404 ì²˜ë¦¬ ê°€ëŠ¥
        # ---------------------------------------------------------------
        return None
