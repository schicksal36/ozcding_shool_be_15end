from tortoise import fields, models
from datetime import datetime, timezone

from app.models.diary import Diary
from app.models.bookmark import Bookmark
from app.models.question import UserQuestion


# =================================================================
# ğŸ”¥ User ëª¨ë¸ â€” ì‚¬ìš©ì ê¸°ë³¸ ì •ë³´ + ëª¨ë“  ê´€ê³„ì˜ ì¤‘ì‹¬ ëª¨ë¸
# =================================================================
class User(models.Model):
    """
    ===============================================================
    USER í…Œì´ë¸”
    ---------------------------------------------------------------
    - ì¸ì¦(Auth) ì‹œìŠ¤í…œì˜ í•µì‹¬ ëª¨ë¸
    - username, hashed_password ë“±ì˜ ì •ë³´ í¬í•¨
    - Diary, Bookmark, TokenBlacklist, UserQuestion ë“±
      ëª¨ë“  ê¸°ëŠ¥ê³¼ ì—°ê²°ë˜ëŠ” ì¤‘ì‹¬ ì—”í‹°í‹°
    ===============================================================
    """

    # -----------------------------------------------------------
    # ğŸ”¹ Primary Key
    # -----------------------------------------------------------
    id = fields.IntField(pk=True)
    """
    AUTO_INCREMENT ì •ìˆ˜í˜• PK
    """

    # -----------------------------------------------------------
    # ğŸ”¹ username (UNIQUE)
    # -----------------------------------------------------------
    username = fields.CharField(max_length=50, unique=True)
    """
    unique=True â†’ ë™ì¼ username ê°€ì… ë¶ˆê°€
    """

    # -----------------------------------------------------------
    # ğŸ”¹ password_hash
    # -----------------------------------------------------------
    password_hash = fields.CharField(max_length=255)
    """
    ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ëŠ” ì ˆëŒ€ ì €ì¥ âŒ
    Passlibë¡œ í•´ì‹±í•œ ë¬¸ìì—´ë§Œ ì €ì¥ â­•
    """

    # -----------------------------------------------------------
    # ğŸ”¹ email (ì˜µì…˜)
    # -----------------------------------------------------------
    email = fields.CharField(max_length=255, null=True)
    """
    null í—ˆìš© â†’ ì´ë©”ì¼ ì—†ì´ ê°€ì… ê°€ëŠ¥
    """

    # -----------------------------------------------------------
    # ğŸ”¥ ì—­ì°¸ì¡° ê´€ê³„ë“¤ (ReverseRelation)
    # -----------------------------------------------------------
    diaries: fields.ReverseRelation["Diary"]
    """
    USER 1 â†’ N DIARY  
    user.diaries: QuerySet

    ì˜ˆ:
        user = await User.get(id=1)
        user_diaries = await user.diaries.all()
    """

    token_entries: fields.ReverseRelation["TokenBlacklist"]
    """
    USER 1 â†’ N TOKEN_BLACKLIST  
    ë¡œê·¸ì•„ì›ƒ ì‹œ TokenBlacklistì— í† í°ì´ ì €ì¥ë¨.
    """

    bookmarks: fields.ReverseRelation["Bookmark"]
    """
    USER 1 â†’ N BOOKMARK  
    ë¶ë§ˆí¬í•œ ëª…ì–¸ë“¤ì˜ ì¤‘ê°„ í…Œì´ë¸” ì ‘ê·¼
    """

    assigned_questions: fields.ReverseRelation["UserQuestion"]
    """
    USER 1 â†’ N USER_QUESTION  
    ì‚¬ìš©ìì—ê²Œ ë°°ì •ëœ ëœë¤ ì§ˆë¬¸ ê¸°ë¡
    """


# =================================================================
# ğŸ”¥ TokenBlacklist ëª¨ë¸ â€” JWT ê°•ì œ ë¡œê·¸ì•„ì›ƒ / ë³´ì•ˆìš©
# =================================================================
class TokenBlacklist(models.Model):
    """
    ===============================================================
    TOKEN_BLACKLIST í…Œì´ë¸”
    ---------------------------------------------------------------
    - í´ë¼ì´ì–¸íŠ¸ê°€ ë¡œê·¸ì•„ì›ƒí–ˆê±°ë‚˜ ê°•ì œ ë¬´íš¨í™”ëœ JWT í† í° ì €ì¥
    - JWTëŠ” stateless ê¸°ë°˜ì´ë¼ ì„œë²„ê°€ ê°•ì œ ë§Œë£Œì‹œí‚¤ê¸° ì–´ë ¤ì›€
      â†’ ì´ í…Œì´ë¸”ì„ ì‚¬ìš©í•´ â€˜ì°¨ë‹¨ëœ í† í°â€™ì„ ê´€ë¦¬í•˜ëŠ” ë°©ì‹ ì±„íƒ

    ì‘ë™ ì›ë¦¬:

        (1) ë¡œê·¸ì•„ì›ƒ ìš”ì²­
             â†’ Access Tokenì„ TokenBlacklistì— ì €ì¥

        (2) get_current_user() ì‹¤í–‰ ì‹œ
             â†’ is_token_blacklisted(token) í˜¸ì¶œ
             â†’ DBì— tokenì´ ì¡´ì¬í•˜ë©´ ì¦‰ì‹œ 401 ë°˜í™˜

    ì´ ë°©ì‹ì€ ë„·í”Œë¦­ìŠ¤, ì¿ íŒ¡ ë“± ê¸°ì—…ì—ì„œë„ ì‚¬ìš©í•˜ëŠ” í‘œì¤€ íŒ¨í„´.
    ===============================================================
    """

    # -----------------------------------------------------------
    # ğŸ”¹ Primary Key
    # -----------------------------------------------------------
    id = fields.IntField(pk=True)

    # -----------------------------------------------------------
    # ğŸ”¹ ì €ì¥ëœ JWT ë¬¸ìì—´
    # -----------------------------------------------------------
    token = fields.TextField()
    """
    ì‹¤ì œ JWT ë¬¸ìì—´ ì €ì¥
    ë³´ì•ˆì„ ìœ„í•´ ë³´í†µ refresh tokenë§Œ ì €ì¥í•˜ê¸°ë„ í•˜ì§€ë§Œ,
    ì—¬ê¸°ì„œëŠ” access tokenë„ ì°¨ë‹¨ ê°€ëŠ¥í•˜ë„ë¡ ì„¤ê³„ë¨.
    """

    # -----------------------------------------------------------
    # ğŸ”¹ user_id FK â€” ì–´ë–¤ ìœ ì €ì˜ í† í°ì¸ì§€
    # -----------------------------------------------------------
    user = fields.ForeignKeyField(
        'models.User',
        related_name='token_entries'
    )
    """
    USER 1 â†’ N TOKEN_BLACKLIST

    íŠ¹ì§•:
    - user.token_entries.all() ë¡œ í•´ë‹¹ ìœ ì €ê°€ ë¡œê·¸ì•„ì›ƒí•œ í† í° ëª¨ë‘ ì¡°íšŒ ê°€ëŠ¥
    - ë³´ì•ˆ ê°ì‚¬ ë° ë¶„ì„ ì‹œ ìœ ìš©
    """

    # -----------------------------------------------------------
    # ğŸ”¹ expired_at â€” í† í° ë§Œë£Œ ì‹œê°„ (ì˜µì…˜)
    # -----------------------------------------------------------
    expired_at = fields.DatetimeField(null=True)
    """
    ì‹¤ì œ JWTì˜ expì™€ ë™ì¼í•˜ê²Œ ì €ì¥í•  ìˆ˜ ìˆìŒ
    - ë§Œë£Œëœ í† í°ì„ DBì—ì„œ ìë™ ì‚­ì œí•  ë•Œ í™œìš©
    - ì˜ˆ: cronjob / background taskì—ì„œ expired_at < now() ì¸ í† í° ì‚­ì œ
    """



