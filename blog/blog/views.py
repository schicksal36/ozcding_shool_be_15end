from django.shortcuts import render, get_object_or_404
from .models import Blog


def blog_list(request):
    # ============================================================
    # 📌 블로그 목록 페이지 View
    #
    # 기능 요약:
    # 1️⃣ Blog 테이블에 저장된 모든 게시글 조회
    # 2️⃣ 쿠키(cookie)를 이용한 전체 방문 횟수 관리
    # 3️⃣ 세션(session)을 이용한 사용자별 방문 횟수 관리
    # 4️⃣ blog_list.html 템플릿 렌더링
    #
    # request 객체:
    # - request.COOKIES  : 클라이언트가 보낸 쿠키 정보
    # - request.session  : 서버에서 관리하는 세션 정보
    # ============================================================


    # ------------------------------------------------------------
    # 1️⃣ 블로그 목록 조회 (ORM)
    # ------------------------------------------------------------
    blogs = Blog.objects.all()
    # 📌 Blog.objects.all()
    # - Blog 모델에 대응되는 테이블(blog_blog)의 모든 행 조회
    # - 반환 타입: QuerySet (지연 평가)
    # - SQL 개념: SELECT * FROM blog_blog;


    # ------------------------------------------------------------
    # 2️⃣ 쿠키(Cookie) 기반 방문 횟수 증가
    # ------------------------------------------------------------
    visits = int(request.COOKIES.get('visits', 0)) + 1
    # 📌 request.COOKIES
    # - 브라우저가 요청과 함께 보낸 쿠키를 dict 형태로 제공
    # - 'visits' 쿠키가 없으면 첫 방문이므로 0
    #
    # ⚠️ 주의:
    # - 쿠키는 클라이언트가 조작 가능
    # - 실제 서비스의 조회수/통계 용도로는 부적합 (학습용 OK)


    # ------------------------------------------------------------
    # 3️⃣ 세션(Session) 기반 사용자별 방문 횟수 증가
    # ------------------------------------------------------------
    request.session['count'] = request.session.get('count', 0) + 1
    # 📌 request.session
    # - Django가 제공하는 서버 측 저장소
    # - 사용자(브라우저)별로 고유하게 관리됨
    #
    # 동작 흐름:
    # 1) 'count' 값이 있으면 가져옴
    # 2) 없으면 0으로 시작
    # 3) 방문 시마다 +1 증가
    #
    # 특징:
    # - 쿠키보다 보안에 유리
    # - 세션 만료 시 초기화됨


    # ------------------------------------------------------------
    # 4️⃣ 템플릿에 전달할 데이터(context)
    # ------------------------------------------------------------
    context = {
        'blogs': blogs,                  # 블로그 목록
        'visits': visits,                # 전체 방문 횟수 (쿠키)
        'count': request.session['count']  # 사용자별 방문 횟수 (세션)
    }
    # 📌 context
    # - 템플릿에서 {{ blogs }}, {{ visits }}, {{ count }} 로 접근 가능


    # ------------------------------------------------------------
    # 5️⃣ 템플릿 렌더링 및 응답(Response) 생성
    # ------------------------------------------------------------
    response = render(request, 'blog_list.html', context)
    # 📌 render()
    # - blog_list.html 템플릿 로드
    # - context 데이터 바인딩
    # - HttpResponse 객체 반환


    # ------------------------------------------------------------
    # 6️⃣ 쿠키 저장
    # ------------------------------------------------------------
    response.set_cookie('visits', visits)
    # 📌 set_cookie()
    # - 응답에 쿠키 추가
    # - 브라우저에 저장되어 다음 요청부터 다시 전송됨


    return response
    # 📌 최종 HTML 응답 반환



def blog_detail(request, pk):
    # ============================================================
    # 📌 블로그 상세 페이지 View
    #
    # 기능 요약:
    # 1️⃣ URL의 pk 값을 이용해 특정 Blog 객체 조회
    # 2️⃣ 객체가 없으면 자동으로 404 응답
    # 3️⃣ blog_detail.html 템플릿 렌더링
    #
    # pk:
    # - urls.py의 <int:pk> 에서 전달된 값
    # - Blog 모델의 Primary Key(id)
    # ============================================================


    # ------------------------------------------------------------
    # 1️⃣ 단일 블로그 게시글 조회
    # ------------------------------------------------------------
    blog = get_object_or_404(Blog, pk=pk)
    # 📌 get_object_or_404()
    # - Blog.objects.get(pk=pk) 시도
    # - 객체가 존재하면 반환
    # - 존재하지 않으면 Http404 발생 → Django가 404 페이지 반환
    #
    # 내부 동작 개념:
    # try:
    #     blog = Blog.objects.get(pk=pk)
    # except Blog.DoesNotExist:
    #     raise Http404


    # ------------------------------------------------------------
    # 2️⃣ 템플릿에 전달할 데이터
    # ------------------------------------------------------------
    context = {
        'blog': blog
        # 📌 blog
        # - 템플릿에서 {{ blog.title }}, {{ blog.content }} 사용
    }


    # ------------------------------------------------------------
    # 3️⃣ 상세 페이지 렌더링
    # ------------------------------------------------------------
    return render(request, 'blog_detail.html', context)
    # 📌 blog_detail.html 템플릿 렌더링
    # - 단일 Blog 객체의 상세 정보를 HTML로 변환
